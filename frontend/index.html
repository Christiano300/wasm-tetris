<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/src/style.css" />
    <script defer type="module" src="/src/index.ts"></script>
    <title>Tetris</title>
    <meta
      name="description"
      content="Tetris game with multiplayer support using WebSockets."
    />
    <script>
      if (
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: light)").matches
      ) {
        document.documentElement.removeAttribute("data-theme");
      }
    </script>
  </head>

  <!-- screen: menu, join, create, wait, setup, play, settings, leaderboard -->

  <body
    x-data="{
  screen: 'menu',
  waitingId: null,
  cookieConsent: 'necessary',
  needCookieConsent: false,
  disableMessage: false,
  darkMode: false,
  lobbySocket: null,
  leaderboard: [],

  async fetchLeaderboard() {
    const response = await fetch(window.backendUrl + '/leaderboard');
    this.leaderboard = await response.json();
  },

  createGame(data) {
  const url = new URL(window.backendUrl + '/create-game');
  url.searchParams.set('jupiter', data.jupiter);
  url.searchParams.set('easy', data.easy);
  url.searchParams.set('nes', data.nes);
  url.searchParams.set('random', data.random);
  this.lobbySocket = new WebSocket(url);

  this.lobbySocket.onmessage = (event) => {
    const parts = event.data.split(' ');
    console.log(parts);
    if (parts[0] === 'lobby') {
    this.waitingId = parts[1];
    } else if (parts[0] === 'ready') {
    this.screen = 'play';
    this.waitingId = null;
    $store.client.connect(parts[1]);
    this.lobbySocket.close();
    }
  }
  },
  setDarkMode() {
    // Only store if cookies are allowed
    if (this.cookieConsent !== 'none') {
      localStorage.setItem('wt_dark', this.darkMode ? '1' : '0');
    }
    if (this.darkMode) {
      document.documentElement.setAttribute('data-theme', 'dark');
    } else {
      document.documentElement.removeAttribute('data-theme');
    }
  },
  init() {
  if (localStorage.getItem('wt_cookie-consent') === null) {
    this.screen = 'settings';
    this.needCookieConsent = true;
  }
  this.cookieConsent = localStorage.getItem('wt_cookie-consent') ?? 'necessary';
  },
  removeAllCookies() {
  localStorage.removeItem('wt_cookie-consent');
  this.removeExtraCookies();
  },
  removeExtraCookies() {
  },
  updateCookiePreference() {
  localStorage.setItem('wt_cookie-consent', this.cookieConsent);
  this.needCookieConsent = false;
  if (this.cookieConsent === 'none') {
    this.removeAllCookies();
    localStorage.removeItem('wt_dark'); // Remove dark mode cookie
  } else if (this.cookieConsent === 'necessary') {
    this.removeExtraCookies();
  }
  }}"
  >
    <header>
      <button
        @click="screen = 'menu'; lobbySocket?.close(); $store.client.stopEverything()"
        x-show="!needCookieConsent && screen !== 'menu'"
        x-cloak
      >
        <span class="back-icon"></span>
        Back to Menu
      </button>
      <button @click="screen = 'settings'" x-show="screen === 'menu'">
        Settings
      </button>
      <button
        @click="screen = 'leaderboard'; fetchLeaderboard()"
        x-show="screen === 'menu'"
      >
        Leaderboard
      </button>
      <div x-show="screen == 'menu' || screen === 'leaderboard'">
        <button @click="screen = 'create'">Create Game</button>
        <button @click="screen = 'join'">Join Game</button>
        <button @click="screen = 'setup'">Play singleplayer</button>
      </div>
    </header>
    <div x-cloak x-show="screen == 'join'" x-data="games">
      <div class="center" id="games-list">
        <p x-show="games.length === 0">No games right now...</p>
        <template x-for="game in games" :key="game.id">
          <div class="game">
            <h2 x-text="game.id"></h2>
            <button
              @click="$store.client.joinAndConnect(game.id); screen = 'play'"
            >
              Join
            </button>
          </div>
        </template>
      </div>
    </div>
    <div
      x-cloak
      x-show="screen == 'leaderboard'"
      class="leaderboard-page"
      x-data="{ lbMode: 'Normal' }"
    >
      <h1>Leaderboard</h1>
      <div class="button-group">
        <button
          @click="lbMode = 'Normal'"
          :class="lbMode === 'Normal' ? 'active' : ''"
        >
          Normal
        </button>
        <button
          @click="lbMode = 'Jupiter'"
          :class="lbMode === 'Jupiter' ? 'active' : ''"
        >
          Jupiter
        </button>
        <button
          @click="lbMode = 'Nes'"
          :class="lbMode === 'Nes' ? 'active' : ''"
        >
          Nes
        </button>
      </div>
      <table class="leaderboard-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Name</th>
            <th>Score</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <template
            x-for="(entry, index) in leaderboard.filter(e => e.mode === lbMode)"
            :key="index"
          >
            <tr>
              <td x-text="index + 1"></td>
              <td x-text="entry.name"></td>
              <td x-text="entry.score"></td>
              <td>
                <img
                  src="assets/duel.svg"
                  alt="duel"
                  class="duel-icon"
                  x-show="entry.was_multiplayer"
                  title="This was a multiplayer game"
                />
                <img
                  src="assets/random.svg"
                  alt="random"
                  class="random-icon"
                  x-show="entry.was_random"
                  title="This game used the random piece generator"
                />
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
    <div class="page-centered">
      <div class="menu" x-show="screen=='menu'">
        <h1 class="title">WASM TETRIS</h1>
        <p class="subtitle">by Christian Patzl</p>
      </div>
      <div
        x-cloak
        class="form"
        x-show="screen == 'create' || screen == 'setup'"
        x-data="{jupiter: false, easy: false, nes: false, random: false}"
      >
        <label>
          <input type="checkbox" x-model="jupiter" />
          Jupiter: Your are always holding down
        </label>
        <label>
          <input type="checkbox" x-model="easy" />
          Easy: No levelup for you
        </label>
        <label>
          <input type="checkbox" x-model="nes" />
          NES: The pieces are sticky
        </label>
        <label>
          <input type="checkbox" x-model="random" />
          Random: No Bag system, pieces are completely random
        </label>
        <span x-show="easy">Warning: games in easy mode are not eligible for a highscore</span>
        <button
          class="create-game"
          x-show="screen == 'create'"
          @click="createGame($data); screen = 'wait'"
        >
          Create Game
        </button>
        <button
          class="create-game"
          x-show="screen == 'setup'"
          @click="$store.client.runSinglePlayer($data); screen = 'play'"
        >
          Create Game
        </button>
      </div>
      <div x-cloak x-show="screen =='wait'">
        <p>Waiting for players to join...</p>
        <p x-text="'Your id: ' + (waitingId ?? 'Loading...')"></p>
      </div>
      <div x-cloak x-show="screen == 'play'" class="tetris">
        <canvas width="650" height="700"></canvas>
      </div>
      <div x-cloak x-show="screen == 'settings'" class="form">
        <h1>Settings</h1>
        <label>
          <input
            type="checkbox"
            x-model="darkMode"
            x-init="darkMode = (localStorage.getItem('wt_dark') === '1'); if (darkMode) document.documentElement.setAttribute('data-theme','dark')"
            @change="setDarkMode"
          />
          Dark mode
        </label>
        <h3>Cookie preferences</h3>
        <p>Which cookies do you want to enable?</p>
        <label>
          <input type="radio" value="none" x-model="cookieConsent" />
          Absolutely no cookies
        </label>
        <label x-show="cookieConsent === 'none'">
          <input type="checkbox" x-model="disableMessage" />
          Disable annoying obnoxious cookie message
        </label>
        <label>
          <input type="radio" value="necessary" x-model="cookieConsent" />
          Only cookies deemed necessary by the EU ePrivacy Directive
        </label>
        <label>
          <input type="radio" value="all" x-model="cookieConsent" />
          All cookies, including those used for anonymous and internal analytics
          (there is no marketing on this site)
        </label>
        <button
          id="update-preference"
          @click="screen = 'menu'; updateCookiePreference()"
        >
          Save and return to menu
        </button>
      </div>
      <div
        x-cloak
        x-show="cookieConsent === 'none' && !disableMessage"
        class="cookie-message"
      ></div>
    </div>
  </body>
</html>
